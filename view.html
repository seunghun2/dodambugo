<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부고장 - 도담부고</title>
    <meta name="description" content="품격있는 모바일 부고장">
    <meta name="color-scheme" content="light dark">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&family=Noto+Serif+KR:wght@400;600;700&display=swap"
        rel="stylesheet">

    <!-- Google Material Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/view-toss.css">
    <link rel="stylesheet" href="css/view-overlay.css">

    <style>
        /* 라이트/다크 모드 토글 */
        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 1000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #E5E8EB;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .dark .theme-toggle {
            background: rgba(44, 44, 46, 0.9);
            border-color: #3A3A3C;
        }

        .theme-toggle .material-symbols-outlined {
            font-size: 24px;
            color: #191F28;
        }

        .dark .theme-toggle .material-symbols-outlined {
            color: #F9FAFB;
        }

        .theme-toggle .moon {
            display: none;
        }

        .dark .theme-toggle .sun {
            display: none;
        }

        .dark .theme-toggle .moon {
            display: block;
        }

        /* 근조화환 보내기 고정 버튼 */
        .fixed-flower-button {
            position: fixed;
            bottom: 84px;
            left: 20px;
            right: 20px;
            z-index: 99;
            max-width: 600px;
            margin: 0 auto;
            pointer-events: none;
        }

        .fixed-flower-button .flower-send-btn {
            pointer-events: auto;
        }

        .flower-send-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            background: #3182F6;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(49, 130, 246, 0.3);
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .flower-send-btn:hover {
            background: #1b64da;
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(49, 130, 246, 0.4);
        }

        .flower-send-btn:active {
            transform: translateY(0);
        }

        .flower-send-btn .material-symbols-outlined {
            font-size: 24px;
        }

        .dark .flower-send-btn {
            background: #4A9EFF;
            box-shadow: 0 4px 20px rgba(74, 158, 255, 0.3);
        }

        .dark .flower-send-btn:hover {
            background: #68B0FF;
            box-shadow: 0 6px 24px rgba(104, 176, 255, 0.4);
        }

        /* 컨텐츠 하단에 공간 확보 */
        .bugo-content {
            padding-bottom: 100px !important;
        }

        @media (max-width: 768px) {
            .fixed-flower-button {
                left: 16px;
                right: 16px;
                bottom: 78px;
            }

            .flower-send-btn {
                padding: 14px 20px;
                font-size: 15px;
            }

            .bugo-content,
            .guestbook-content {
                padding-bottom: 160px !important;
            }
        }
    </style>
</head>

<body>
    <!-- 테마 토글 -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="다크모드 토글">
        <span class="material-symbols-outlined sun">light_mode</span>
        <span class="material-symbols-outlined moon">dark_mode</span>
    </button>

    <!-- Loading -->
    <div id="loading" class="loading-container">
        <div class="loading-spinner"></div>
        <p>부고장을 불러오는 중...</p>
    </div>

    <!-- Error -->
    <div id="error" class="error-container" style="display: none;">
        <div class="error-content">
            <div class="error-icon">⚠️</div>
            <h2>부고장을 찾을 수 없습니다</h2>
            <p>존재하지 않거나 삭제된 부고장입니다.</p>
            <div class="error-actions">
                <a href="search.html" class="btn-secondary">부고 검색하기</a>
                <a href="index.html" class="btn-primary">홈으로 돌아가기</a>
            </div>
        </div>
    </div>

    <!-- Bugo View -->
    <main id="bugoView" class="bugo-view" style="display: none;">
        <!-- 썸네일 헤더 (이미지 + 텍스트 오버레이) -->
        <div class="bugo-header" id="bugoHeader">
            <img id="templateImage" src="" alt="부고장 템플릿">
            <div class="text-overlay" id="textOverlay">
                <!-- 정중형 전체 메시지 -->
                <p class="overlay-text overlay-full-message" id="overlayFullMessage"
                    style="display: none; font-size: 16px; font-weight: 700; text-align: center !important; color: #1a1a1a; line-height: 1.8; width: 100%; margin: 0 auto; padding: 0; left: 0; right: 0;">
                    故홍길동님께서 11월 25일<br>
                    별세하셨기에 삼가 알려드립니다.<br>
                    마음으로 따뜻한 위로 부탁드리며<br>
                    고인의 명복을 빌어주시길 바랍니다.
                </p>

                <!-- 기존 개별 요소 (다른 템플릿용) -->
                <p class="overlay-text overlay-deceased-name" id="overlayDeceasedName">
                    故 홍길동 님
                </p>
                <p class="overlay-text overlay-death-info" id="overlayDeathInfo">
                    11월 25일 별세
                </p>
                <p class="overlay-text overlay-condolence" id="overlayCondolence">
                    삼가 고인의 명복을 빕니다.
                </p>
            </div>
        </div>

        <!-- 탭 네비게이션 -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('info')">
                <span class="material-symbols-outlined">info</span>
                <span>부고정보</span>
            </button>
            <button class="tab-btn" onclick="switchTab('guestbook')">
                <span class="material-symbols-outlined">edit_note</span>
                <span>방명록</span>
            </button>
        </div>

        <!-- 컨텐츠 -->
        <div class="bugo-content" id="bugoInfoContent">
            <!-- 영정 사진 -->
            <section class="content-section photo-section" id="photoSection" style="display: none;">
                <div class="deceased-photo-container">
                    <img id="deceasedPhoto" src="" alt="영정 사진" class="deceased-photo">
                </div>
            </section>

            <!-- 고인 정보 -->
            <section class="content-section">
                <h3 class="content-title">고인</h3>
                <div class="info-list">
                    <div class="info-row">
                        <span class="info-label">고인</span>
                        <span class="info-value" id="deceasedNameInfo">故 홍길동</span>
                    </div>
                    <div class="info-row" id="ageRow">
                        <span class="info-label">향년</span>
                        <span class="info-value" id="age">75세</span>
                    </div>
                    <div class="info-row" id="genderRow">
                        <span class="info-label">성별</span>
                        <span class="info-value" id="gender">남</span>
                    </div>
                    <div class="info-row" id="religionRow">
                        <span class="info-label">종교</span>
                        <span class="info-value" id="religion">불교</span>
                    </div>
                </div>
            </section>

            <!-- 상주 정보 -->
            <section class="content-section">
                <h3 class="content-title">상주</h3>
                <div id="mournersInfo" class="mourners-list">
                    <!-- JavaScript로 생성 -->
                </div>
            </section>

            <!-- 빈소 정보 -->
            <section class="content-section">
                <h3 class="content-title">빈소</h3>
                <div class="info-list">
                    <div class="info-row">
                        <span class="info-label">장례식장</span>
                        <span class="info-value" id="funeralHome">-</span>
                    </div>
                    <div class="info-row" id="roomRow">
                        <span class="info-label">호실</span>
                        <span class="info-value" id="roomNumber">-</span>
                    </div>
                    <div class="info-row" id="funeralTelRow">
                        <span class="info-label">연락처</span>
                        <span class="info-value">
                            <a href="tel:" id="funeralTelLink">-</a>
                        </span>
                    </div>
                    <div class="info-row" id="addressRow">
                        <span class="info-label">주소</span>
                        <span class="info-value" id="address">-</span>
                    </div>
                </div>
            </section>

            <!-- 일정 정보 -->
            <section class="content-section">
                <h3 class="content-title">일정</h3>
                <div class="info-list">
                    <div class="info-row">
                        <span class="info-label">별세</span>
                        <span class="info-value" id="deathDatetime">-</span>
                    </div>
                    <div class="info-row" id="encoffinRow">
                        <span class="info-label">입관</span>
                        <span class="info-value" id="encoffinDatetime">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">발인</span>
                        <span class="info-value" id="funeralDatetime">-</span>
                    </div>
                    <div class="info-row" id="funeralTypeRow">
                        <span class="info-label">장례방법</span>
                        <span class="info-value" id="funeralType">-</span>
                    </div>
                    <div class="info-row" id="burialPlaceRow">
                        <span class="info-label">장지</span>
                        <span class="info-value" id="burialPlace">-</span>
                    </div>
                </div>
            </section>

            <!-- 지도 -->
            <section class="content-section map-section" id="mapSection">
                <div class="map-header">
                    <h3 class="content-title">오시는 길</h3>
                </div>
                <div id="map" class="map-container">
                    <!-- Kakao Map -->
                </div>
                <div class="map-actions">
                    <button class="map-btn" onclick="openKakaoMap()">
                        <svg width="18" height="18" fill="none" viewBox="0 0 20 20" stroke="currentColor"
                            stroke-width="1.5">
                            <path
                                d="M10 2.5c-3.866 0-7 2.686-7 6 0 3.866 4.667 8.333 7 9.5 2.333-1.167 7-5.634 7-9.5 0-3.314-3.134-6-7-6z" />
                            <circle cx="10" cy="8.5" r="2" />
                        </svg>
                        길찾기
                    </button>
                    <button class="map-btn primary" onclick="shareBugo()">
                        <svg width="18" height="18" fill="none" viewBox="0 0 20 20" stroke="currentColor"
                            stroke-width="1.5">
                            <path
                                d="M15 6.667a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5zM5 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5zM15 18.333a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z" />
                            <path d="M7.083 11.25l5.834 3.167M12.917 5.583L7.083 8.75" />
                        </svg>
                        공유하기
                    </button>
                </div>
            </section>

            <!-- 안내 메시지 -->
            <section class="content-section" id="messageSection" style="display: none;">
                <h3 class="content-title">안내하는 글</h3>
                <div class="condolence-message">
                    <p class="condolence-text" id="message"></p>
                </div>
            </section>

            <!-- 계좌 정보 -->
            <section class="content-section" id="accountSection" style="display: none;">
                <h3 class="content-title">계좌 정보</h3>
                <div id="accountInfo" class="account-list">
                    <!-- JavaScript로 생성 -->
                </div>
            </section>

            <!-- 하단 안내 -->
            <section class="content-section">
                <div class="footer-notice">
                    <p class="notice-text">
                        황망한 마음에 일일이 연락드리지 못함을<br>
                        너그러이 양해해 주시기 바랍니다.
                    </p>
                </div>
            </section>
        </div>

        <!-- 방명록 컨텐츠 -->
        <div class="guestbook-content" id="guestbookContent" style="display: none;">
            <!-- 방명록 작성 폼 -->
            <section class="content-section">
                <h3 class="content-title">조문 작성하기</h3>
                <form id="guestbookForm" onsubmit="submitGuestbook(event)">
                    <div class="form-group">
                        <input type="text" id="guestName" class="form-input" placeholder="이름" required maxlength="20">
                    </div>
                    <div class="form-group">
                        <input type="password" id="guestPassword" class="form-input" placeholder="비밀번호 4자리 (수정/삭제 시 필요)"
                            required maxlength="4" pattern="[0-9]{4}">
                    </div>
                    <div class="form-group">
                        <textarea id="guestMessage" class="form-textarea" placeholder="따뜻한 위로의 말씀을 전해주세요." required
                            maxlength="500" rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn-submit-guestbook">
                        <span class="material-symbols-outlined">edit</span>
                        <span>조문 남기기</span>
                    </button>
                </form>
            </section>

            <!-- 방명록 목록 -->
            <section class="content-section">
                <div class="guestbook-header">
                    <h3 class="content-title">방명록</h3>
                    <span class="guestbook-count" id="guestbookCount">0</span>
                </div>
                <div id="guestbookList" class="guestbook-list">
                    <!-- JavaScript로 생성 -->
                </div>
                <div id="guestbookEmpty" class="guestbook-empty" style="display: none;">
                    <span class="material-symbols-outlined">edit_note</span>
                    <p>아직 작성된 방명록이 없습니다.</p>
                    <p class="empty-hint">첫 번째 방명록을 남겨주세요.</p>
                </div>
                <!-- 더보기 버튼 -->
                <button id="loadMoreBtn" class="btn-load-more" onclick="loadMoreGuestbook()" style="display: none;">
                    더 보기
                </button>
            </section>
        </div>

        <!-- 하단 액션 버튼 -->
        <div class="bugo-actions">
            <button class="action-btn btn-primary" onclick="shareBugo()">
                <span class="material-symbols-outlined">share</span>
                <span>공유하기</span>
            </button>
        </div>
    </main>

    <!-- 근조화환 보내기 고정 버튼 -->
    <div class="fixed-flower-button">
        <button class="flower-send-btn" onclick="sendCondolenceFlower()">
            <span class="material-symbols-outlined">local_florist</span>
            <span>근조화환 보내기</span>
        </button>
    </div>

    <!-- 방명록 수정/삭제 모달 -->
    <div id="guestbookActionModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-overlay" onclick="closeGuestbookActionModal()"></div>
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>방명록 관리</h3>
                <button class="edit-modal-close" onclick="closeGuestbookActionModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="edit-modal-body">
                <p class="edit-modal-description">작성 시 입력한 비밀번호 4자리를 입력하세요.</p>
                <input type="password" id="guestbookPassword" class="edit-password-input" placeholder="비밀번호 4자리"
                    maxlength="4" pattern="[0-9]{4}">
                <div id="guestbookError" class="edit-error" style="display: none;"></div>
            </div>
            <div class="edit-modal-footer" style="display: flex; gap: 8px;">
                <button class="btn-cancel" onclick="closeGuestbookActionModal()">취소</button>
                <button class="btn-delete" onclick="deleteGuestbookEntry()"
                    style="background: #E03131; color: white; flex: 1;">삭제</button>
                <button class="btn-confirm" onclick="editGuestbookEntry()" style="flex: 1;">수정</button>
            </div>
        </div>
    </div>

    <!-- Kakao Map API -->
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_APP_KEY&libraries=services"></script>

    <script src="js/view-new.js"></script>

    <script>
        // 다크모드 토글
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            
            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // 페이지 로드 시 테마 복원
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        });
        
        // 시스템 다크모드 변경 감지
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('theme')) {
                if (e.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
        });
    </script>
</body>

</html>